#!/usr/bin/python

"""
Dependencies:
  dateutil.parser - http://labix.org/python-dateutil
  feedparser      - http://www.feedparser.org
  stripogram      - http://www.zope.org/Members/chrisw/StripOGram
  django          - http://www.djangoproject.com
"""

__copyright__ = "Copyright 2010, Jack Lloyd"
__license__   = "GPLv2"
__author__    = "Jack Lloyd"
__version__   = "0.1"
__email__     = "lloyd@randombit.net"

import logging
import multiprocessing
import optparse
import os
import smtplib
import socket
import sys
import ConfigParser

import dateutil.parser
import feedparser
import stripogram

from email.MIMEText import MIMEText
from django.utils.encoding import smart_str

def conf_dir():
    if os.getenv('GRAB_RSS_DIR'):
        return os.getenv('GRAB_RSS_DIR')
    return os.path.join(os.getenv('HOME'), '.grab_rss')

def feedlist():
    feed_file = os.path.join(conf_dir(), 'feeds.txt')

    logging.info('Reading feed list from %s' % (feed_file))

    try:
        return map(lambda s: s.strip(), open(feed_file).readlines())
    except IOError:
        raise Exception('No feeds found in %s' % (feed_file))

def read_config():
    config = ConfigParser.RawConfigParser(
        {
            'from': 'grab-rss@localhost',
            'smtp_host': 'localhost',
            'socket_timeout': '30',
            'user_agent': feedparser.USER_AGENT,
            'pool_size': 4
        })

    config_file = os.path.join(conf_dir(), 'grab_rss.conf')

    try:
        config.readfp(open(config_file))
    except IOError:
        pass

    return config

class seen_items:
    def __init__(self, filename):
        self.all_seen = set()
        self.filename = filename

        try:
            input = open(self.filename)
            for line in input:
                self.all_seen.add(line.strip())
        except IOError:
            pass

    def save(self):
        output = open(self.filename, 'w')
        for entry in sorted(self.all_seen):
            output.write(entry)
            output.write('\n')
        output.close()

    def seen_this_before(self, item):
        return item in self.all_seen

    def note_as_seen(self, item):
        self.all_seen.add(item)

def wrap(text, width):
    # From http://code.activestate.com/recipes/148061/
    return reduce(lambda line, word, width=width: '%s%s%s' %
                  (line,
                   ' \n'[(len(line)-line.rfind('\n')-1
                         + len(word.split('\n',1)[0]
                              ) >= width)],
                   word),
                  text.split(' ')
                 )

def body_for(entry):

    # Random chars observered that smart_str fails on
    encodings = {
        '\xe2\x80\x93': '\'',
        '\xe2\x80\x99': '\'',
        '\xe2\x80\x9c': '\'',
        '\xe2\x80\x9d': '\'',
        '\xc3\xa1': 'a',
        '\xc2\xa0': '',
        '\xbb': '>>',
        '&#38;': '&',
        '&#038;': '&',
        '&#60;': '<',
        '&#62;': '>',
        '&#xA0;': ' ',
        '&#8216;': '\'',
        '&#8217;': '\'',
        '&#8220;': '\'',
        '&#8221;': '\'',
        '&#8212;': '--',
        '&#8243;': '"',
        }

    timestamp = str(dateutil.parser.parse(entry.get('date', '')))

    s = timestamp + '\n\n' + smart_str(entry.link + '\n\n' +
                                       entry.get('description', ''))

    for (coded,char) in encodings.items():
        s = s.replace(coded, char)

    return wrap(stripogram.html2safehtml(s, valid_tags=('a')), 80)

def feed_name(feed, feed_url):
    try:
        return feed['feed']['title']
    except:
        return feed_url.split('/')[3]

def parse_feed(url):
    logging.info('Reading %s' % (url))
    return (url, feedparser.parse(url))

def grab_feeds(config):
    state = seen_items(os.path.join(conf_dir(), 'seen.txt'))

    pool = multiprocessing.Pool(config.getint('GrabRSS', 'pool_size'))

    # Use multiprocessing's Pool.map? (Broken on chihiro... :/)
    all_feeds = dict(pool.map(parse_feed, feedlist()))

    for (feed_url, feed) in all_feeds.items():
        feed_title = feed_name(feed, feed_url)

        num_entries = len(feed.entries)

        if num_entries:
            logging.debug('Found %d entries in %s' % (num_entries, feed_url))
        else:
            logging.info('Found no entries in %s' % (feed_url))

        new_entries = 0

        for entry in feed.entries:
            if state.seen_this_before(entry.link):
                continue

            title = entry.get('title', entry.link)

            msg = MIMEText(body_for(entry))
            msg['X-GrabRSS'] = socket.gethostname()
            msg['Subject'] = '%s - %s' % (feed_title, title)
            msg['From'] = config.get('GrabRSS', 'from')
            msg['To'] = config.get('GrabRSS', 'to')
            yield msg

            new_entries += 1

            state.note_as_seen(entry.link)

        logging.debug('Saw %d new items from %s' % (new_entries, feed_url))

        state.save()

def main(argv = None):
    if argv is None:
        argv = sys.argv

    parser = optparse.OptionParser(version='%%prog %s' % (__version__))

    parser.add_option('-v', '--verbose', dest='verbose',
                      action='store_true', default=False)

    parser.add_option('-q', '--quiet', dest='quiet',
                      action='store_true', default=False)

    (options, args) = parser.parse_args(argv)

    def log_level():
        if options.quiet: # -q overrides -v
            return logging.WARNING
        if options.verbose:
            return logging.DEBUG
        return logging.INFO

    logging.basicConfig(stream = sys.stdout,
                        format = '%(levelname) 7s: %(message)s',
                        level = log_level())

    config = read_config()

    socket.setdefaulttimeout(config.getint('GrabRSS', 'socket_timeout'))
    feedparser.USER_AGENT = config.get('GrabRSS', 'user_agent')

    socket.setdefaulttimeout(10)

    smtp_host = config.get('GrabRSS', 'smtp_host')

    logging.debug('Sending mail to %s' % (smtp_host))

    smtp = smtplib.SMTP(smtp_host)

    for email in grab_feeds(config):
        smtp.sendmail(email['From'], [email['To']], email.as_string())

    smtp.quit()

if __name__ == '__main__':
    #try:
    sys.exit(main())
    #except Exception, e:
    #    print >>sys.stderr, e
